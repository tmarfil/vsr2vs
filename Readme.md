# NGINX Ingress VirtualServer Routes with Kustomize

Managing hundreds of routes within a single Kubernetes `VirtualServer` manifest is complex and error-prone. This solution provides a scalable and automated alternative by:

1.  Separating the base `VirtualServer` configuration from individual `VirtualServerRoute` definitions.
2.  Storing each `VirtualServerRoute` in its own YAML file within a `routes/` directory.
3.  Using a single helper script to dynamically generate two key files:
    *   `kustomization.yaml`: Automatically includes all `VirtualServerRoute` manifests.
    *   `routes-patch.yaml`: Injects the necessary route references into the main `VirtualServer`.

This approach ensures that you only need to manage your route files; the Kustomize configuration is generated for you automatically.

## Directory Structure

Your project should follow this structure. The `kustomization.yaml` and `routes-patch.yaml` files are auto-generated.

```
.
├── base/
│   ├── kustomization.yaml
│   └── virtualserver.yaml      # Base VS definition
├── routes/
│   ├── login-route.yaml      # Example VSR
│   └── profile-route.yaml    # Example VSR
├── build-kustomize.sh        # The single script to generate Kustomize configs
├── .gitignore
├── kustomization.yaml          # <-- Generated by script
└── routes-patch.yaml         # <-- Generated by script
```

## Setup Instructions

### 1. Create the Base VirtualServer

Define your main `VirtualServer` without any of the dynamic route references. This file should contain defaults, TLS configuration, and upstreams that might be shared or used by the base path.

```yaml
# base/virtualserver.yaml
apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: main-application
  namespace: nginx-ingress # Ensure this matches your environment
spec:
  host: myapp.example.com
  tls:
    secret: myapp-tls
    redirect:
      enable: true
  upstreams:
    - name: main-app
      service: main-app-svc
      port: 80
  # Define a base/default route here if needed.
  routes:
    - path: /
      action:
        pass: main-app
    # Dynamic routes for VirtualServerRoutes will be added via patch.
```

### 2. Create Base Kustomization File

This file simply includes the base `VirtualServer` manifest. It does not change.

```yaml
# base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - virtualserver.yaml
```

### 3. Create the Kustomize Generator Script

This is the core of the automated solution. This single script finds all `*-route.yaml` files in the `routes/` directory and generates both the `kustomization.yaml` and `routes-patch.yaml` files.

```bash
#!/bin/bash
# build-kustomize.sh
#
# This script automatically generates BOTH the kustomization.yaml AND the
# routes-patch.yaml files based on the contents of the 'routes/' directory.
#
set -e

# --- Configuration ---
ROUTES_DIR="routes"
KUSTOMIZATION_FILE="kustomization.yaml"
PATCH_FILE="routes-patch.yaml"
NAMESPACE="nginx-ingress" # Ensure this matches your VS/VSR namespace

# --- Part 1: Generate kustomization.yaml ---
echo "Generating ${KUSTOMIZATION_FILE}..."

# Start with the static parts of the kustomization file
cat > $KUSTOMIZATION_FILE << EOL
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  # Include the base VirtualServer definition
  - base
EOL

# Find all route files and append them to the resources list
# The shell's glob expansion (*) is reliable and used here to build the file.
for route_file in ${ROUTES_DIR}/*-route.yaml; do
  if [[ -f "$route_file" ]]; then
    # Add the file path to the kustomization resources list
    echo "  - ${route_file}" >> $KUSTOMIZATION_FILE
  fi
done

# Add the final static patch section
cat >> $KUSTOMIZATION_FILE << EOL

patches:
  - path: ${PATCH_FILE}
EOL
echo "Successfully generated ${KUSTOMIZATION_FILE}."


# --- Part 2: Generate routes-patch.yaml ---
echo -e "\nGenerating ${PATCH_FILE}..."

# Start with the patch header
cat > $PATCH_FILE << EOL
apiVersion: k8s.nginx.org/v1
kind: VirtualServer
metadata:
  name: main-application
  namespace: ${NAMESPACE}
spec:
  routes:
EOL

# Find all route files and append their references to the patch
find "${ROUTES_DIR}" -maxdepth 1 -name '*-route.yaml' -print0 | while IFS= read -r -d $'\0' route_file; do
  if [[ -f "$route_file" ]]; then
    resource_name=$(basename "$route_file" .yaml)
    path_prefix=$(echo "$resource_name" | sed 's/-route$//')

    cat >> $PATCH_FILE << EOL
    # Route added from ${route_file}
    - path: /${path_prefix}
      route: ${NAMESPACE}/${resource_name}
EOL
  fi
done
echo "Successfully generated ${PATCH_FILE}."
```

Make the script executable:
```bash
chmod +x build-kustomize.sh
```

### 4. Create an Initial Route File

Create at least one `VirtualServerRoute` file in the `routes/` directory so the script has something to find.

```yaml
# routes/login-route.yaml
apiVersion: k8s.nginx.org/v1
kind: VirtualServerRoute
metadata:
  name: login-route
  namespace: nginx-ingress # Should match NAMESPACE in script and VS
spec:
  upstreams:
    - name: login-service
      service: login-svc
      port: 80
  subroutes:
    - path: /details
      action:
        pass: login-service
```

### 5. Git Ignore Generated Files

Add the generated files to your `.gitignore` to avoid committing them to version control.

```
# .gitignore
kustomization.yaml
routes-patch.yaml
```

## Workflow

Your daily workflow is now streamlined. You only need to manage files in the `routes/` directory and run the helper script.

### Initial Generation and Deployment

1.  **Run the generator script** to create your Kustomize configuration for the first time.
    ```bash
    ./build-kustomize.sh
    ```

2.  **(Optional) Verify the changes** with a dry-run build.
    ```bash
    kustomize build .
    ```
    This shows you the final, combined manifest that will be sent to the cluster. Inspect it to ensure your base `VirtualServer` has the new route reference and that the `VirtualServerRoute` resource is included.

3.  **Apply the changes** to your cluster.
    ```bash
    kustomize build . | kubectl apply -f -
    ```

### Adding a New Route

1.  **Create a new `VirtualServerRoute` file** in the `routes/` directory (e.g., `account-route.yaml`). Ensure the filename follows the `name-route.yaml` convention.

2.  **Run the generator script.**
    ```bash
    ./build-kustomize.sh
    ```

3.  **Apply the changes.**
    ```bash
    kustomize build . | kubectl apply -f -
    ```

### Removing an Existing Route

1.  **Delete the file** from the `routes/` directory (e.g., `rm routes/login-route.yaml`).

2.  **Run the generator script.** The script will see the file is gone and will automatically regenerate `kustomization.yaml` and `routes-patch.yaml` without the corresponding entries.
    ```bash
    ./build-kustomize.sh
    ```

3.  **Apply the changes.** `kubectl apply` will update the `VirtualServer` to remove the route reference and will remove the `VirtualServerRoute` object from the cluster (if using `--prune` or a GitOps tool).
    ```bash
    kustomize build . | kubectl apply -f -
    ```
